<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bundle Analysis Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700;900&family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "#9247C2",
                            dark: "#351d48",
                            foreground: "#ffffff",
                        },
                        secondary: {
                            DEFAULT: "#0dd3c5",
                            foreground: "#000000",
                        },
                        success: {
                            DEFAULT: "#34c759",
                            foreground: "#ffffff",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    fontFamily: {
                        sans: ['Lato', 'system-ui', 'sans-serif'],
                        mono: ['IBM Plex Mono', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
             
            --background: 210 40% 98%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 274 58% 52%;
            --radius: 0.75rem;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;

             
            --color-header-0: #DEB4FF;   
            --color-header-1: #B190CC;   
            --color-header-2: #856C99;   
            --color-header-3: #584866;   
            --color-header-4: #2C2433;   

             
            --color-framework: #5B7FDB;           
            --color-library: #0dd3c5;             
            --color-native: #ff9500;              
            --color-image: #30d158;               
            --color-asset-catalog: #59886b;       
            --color-resource: #64d2ff;            
            --color-ui: #bf5af2;                  
            --color-dex: #ac8e68;                 
            --color-font: #6a097d;                
            --color-video: #0e49b5;               
            --color-audio: #ff6b35;               
            --color-mlmodel: #583D72;             
            --color-localization: #ffa45b;        
            --color-duplicate: #ff453a;           
            --color-other: #98989d;               
        }

        .dark {
             
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 8%;
            --card-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 274 58% 52%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
        }

        @layer base {
            * {
                @apply border-border;
            }
            body {
                @apply bg-background text-foreground;
                font-feature-settings: "rlig" 1, "calt" 1;
            }
        }

         
        .chart {
            width: 100%;
            height: 450px;
        }

        #treemap {
            width: 100%;
            height: 600px;
        }

         
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

         
        .insight-files {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .insight-card.expanded .insight-files {
            overflow-y: auto;
        }

        .expand-indicator {
            transition: transform 0.3s ease;
        }

        .insight-card.expanded .expand-indicator {
            transform: rotate(180deg);
        }

         
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

         
        .tooltip-trigger {
            position: relative;
            display: inline-flex;
        }

        .tooltip-content {
            position: absolute;
            z-index: 50;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            background: hsl(var(--popover));
            color: hsl(var(--popover-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            font-size: 0.875rem;
            line-height: 1.25rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 150ms ease-in-out;
            text-transform: none;
        }

        .dark .tooltip-content {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
        }

        .tooltip-trigger:hover .tooltip-content,
        .tooltip-trigger:focus .tooltip-content {
            opacity: 1;
        }

         
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: hsl(var(--border));
        }

        .tooltip-content::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 3px solid transparent;
            border-top-color: hsl(var(--popover));
            z-index: 1;
        }

         
        .tooltip-bottom .tooltip-content {
            bottom: auto;
            top: calc(100% + 8px);
        }

        .tooltip-bottom .tooltip-content::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: hsl(var(--border));
        }

        .tooltip-bottom .tooltip-content::before {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: hsl(var(--popover));
        }

         
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="font-sans antialiased bg-background text-foreground">
    
    <header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="w-full max-w-7xl mx-auto px-6">
            <div class="flex h-16 items-center justify-between">
                
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" class="h-8 w-8" aria-label="Bitrise">
                        <defs>
                            <linearGradient id="bitrise-gradient" x1="0" y1="0" x2="1" y2="1">
                                <stop offset="0" style="stop-color:#9247C2;stop-opacity:1" />
                                <stop offset="1" style="stop-color:#0dd3c5;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect x="20" y="20" width="200" height="200" rx="40" fill="url(#bitrise-gradient)"/>
                        <path d="M120 80 L160 120 L120 160 L80 120 Z" fill="white" opacity="0.9"/>
                        <circle cx="120" cy="120" r="15" fill="white"/>
                    </svg>
                    <div class="flex flex-col">
                        <span class="font-semibold text-lg leading-none tracking-tight">Bundle Inspector</span>
                        <span class="text-xs text-muted-foreground leading-none">Size Analysis Report</span>
                    </div>
                </div>

                
                <button data-action="toggle-theme"
                        class="tooltip-trigger tooltip-bottom inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 w-9 relative group"
                        aria-label="Toggle Mode (D)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4.5 w-4.5 transition-transform group-hover:scale-110">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                        <path d="M12 3l0 18"></path>
                        <path d="M12 9l4.65 -4.65"></path>
                        <path d="M12 14.3l7.37 -7.37"></path>
                        <path d="M12 19.6l8.85 -8.85"></path>
                    </svg>
                    <span class="tooltip-content">Toggle theme (D)</span>
                </button>
            </div>
        </div>
    </header>

    
    <main class="w-full">
        <div class="w-full max-w-7xl mx-auto px-6 py-6 space-y-6">
        
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            
            <div class="bg-gradient-to-r from-primary/5 to-primary/10 px-6 py-5 border-b rounded-t-lg">
                <div class="flex items-center gap-4">
                    
                    <div class="flex-grow min-w-0">
                        <h1 class="scroll-m-20 text-3xl font-bold tracking-tight truncate">Bundle Analysis Report</h1>
                        
                    </div>
                </div>
            </div>

            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-border">
                
                
                <div class="bg-card px-5 py-4">
                    <div class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1 flex items-center gap-1.5">
                        <span>Platform</span>
                        <span class="tooltip-trigger inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground/30 text-[10px] cursor-help hover:bg-muted transition-colors">
                            ?
                            <span class="tooltip-content">The operating system platform (iOS, Android)</span>
                        </span>
                    </div>
                    <div class="text-lg font-semibold">Android</div>
                </div>
                

                
                

                
                
                <div class="bg-card px-5 py-4">
                    <div class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1 flex items-center gap-1.5">
                        <span>Type</span>
                        <span class="tooltip-trigger inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground/30 text-[10px] cursor-help hover:bg-muted transition-colors">
                            ?
                            <span class="tooltip-content">IPA (iOS App Store), APK (Android Package), or AAB (Android App Bundle)</span>
                        </span>
                    </div>
                    <div class="text-lg font-semibold uppercase">apk</div>
                </div>
                

                
                <div class="bg-card px-5 py-4">
                    <div class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1 flex items-center gap-1.5">
                        <span>Savings</span>
                        <span class="tooltip-trigger inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground/30 text-[10px] cursor-help hover:bg-muted transition-colors">
                            ?
                            <span class="tooltip-content">Potential size reduction from optimizations (duplicates, compression)</span>
                        </span>
                    </div>
                    <div class="text-lg font-bold text-green-600 dark:text-green-500">0 B</div>
                </div>
            </div>

            
            <div class="bg-card px-6 py-4 border-t rounded-b-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-muted-foreground flex items-center gap-1.5">
                            <span>Download Size</span>
                            <span class="tooltip-trigger inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground/30 text-[10px] cursor-help hover:bg-muted transition-colors">
                                ?
                                <span class="tooltip-content">Size users download from the app store (compressed)</span>
                            </span>
                        </span>
                        <span class="text-xl font-semibold">331 B</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-muted-foreground flex items-center gap-1.5">
                            <span>Install Size</span>
                            <span class="tooltip-trigger inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground/30 text-[10px] cursor-help hover:bg-muted transition-colors">
                                ?
                                <span class="tooltip-content">Size on device after installation (uncompressed)</span>
                            </span>
                        </span>
                        <span class="text-xl font-semibold">192 B</span>
                    </div>
                </div>
            </div>
        </div>

            
            <div class="space-y-4">
            <div class="inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground">
                <button class="tab-button active bg-background text-foreground shadow-sm inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 gap-2"
                        data-action="switch-tab" data-tab="app-analyzer" title="App Analyzer `A`">App Analyzer <kbd class="hidden sm:inline-flex h-5 select-none items-center rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">A</kbd></button>
                <button class="tab-button inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 gap-2"
                        data-action="switch-tab" data-tab="category" title="Category `C`">Category <kbd class="hidden sm:inline-flex h-5 select-none items-center rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">C</kbd></button>
                <button class="tab-button inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 gap-2"
                        data-action="switch-tab" data-tab="files" title="Files `F`">Files <kbd class="hidden sm:inline-flex h-5 select-none items-center rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">F</kbd></button>
                <button class="tab-button inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 gap-2"
                        data-action="switch-tab" data-tab="insights" title="Insights `I`">Insights <span id="insights-badge" class="hidden sm:inline-flex h-5 items-center rounded-full border bg-muted text-muted-foreground px-2 font-mono text-[10px] font-semibold"></span> <kbd class="hidden sm:inline-flex h-5 select-none items-center rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">I</kbd></button>
            </div>

            <section id="app-analyzer-panel" class="tab-panel active" aria-labelledby="treemap-heading">
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                    <h2 id="treemap-heading" class="scroll-m-20 text-2xl font-semibold tracking-tight">Bundle Treemap</h2>
                    <p class="text-sm text-muted-foreground leading-relaxed mt-1.5 mb-4">Click to drill down into folders. Use mouse wheel to zoom. Use breadcrumb to navigate back.</p>
                    <div class="mb-4">
                        <label for="search-input" class="sr-only">Search files</label>
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="search-input"
                                   class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-10 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                   placeholder="Search files (e.g., .png, Frameworks/, &#96;Assets.car&#96;)"
                                   aria-describedby="search-hint">
                            <span id="search-hint" class="sr-only">Use backticks for exact module match, forward slash for path search</span>
                        </div>
                    </div>
                    <div id="treemap" role="img" aria-label="Bundle size treemap visualization"></div>
                    <div id="legend-container" class="flex flex-wrap gap-4 mt-4 pt-4 border-t border-border" role="list" aria-label="File type legend"></div>
                </div>
            </section>

            <section id="category-panel" class="tab-panel" aria-labelledby="category-heading">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 hover:-translate-y-0.5 transition-transform duration-300">
                        <h2 id="category-heading" class="scroll-m-20 text-xl font-semibold tracking-tight mb-6">Category Breakdown</h2>
                        <div id="category-chart" class="chart" role="img" aria-label="Category breakdown pie chart"></div>
                    </div>
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 hover:-translate-y-0.5 transition-transform duration-300">
                        <h2 class="scroll-m-20 text-xl font-semibold tracking-tight mb-6">Top Extensions</h2>
                        <div id="extension-chart" class="chart" role="img" aria-label="Top file extensions bar chart"></div>
                    </div>
                </div>
            </section>

            <section id="files-panel" class="tab-panel" aria-labelledby="files-heading">
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6 hover:-translate-y-0.5 transition-transform duration-300">
                    <h2 id="files-heading" class="scroll-m-20 text-2xl font-semibold tracking-tight mb-2">File Breakdown</h2>
                    <p class="text-sm text-muted-foreground leading-relaxed mb-4">All files in the bundle sorted by size</p>

                    
                    <div class="mb-4">
                        <label for="files-search-input" class="sr-only">Search files</label>
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="files-search-input"
                                   class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-10 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                                   placeholder="Search files by path or extension..."
                                   data-action="filter-files">
                        </div>
                    </div>

                    
                    <div id="files-table-container"></div>
                </div>
            </section>

            <section id="insights-panel" class="tab-panel" aria-labelledby="insights-heading">
                <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="insights-heading" class="scroll-m-20 text-2xl font-semibold tracking-tight flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary" aria-hidden="true"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.3A7 7 0 0 0 12 2z"/></svg>
                            Insights & Optimization Opportunities
                        </h2>
                        <button data-action="toggle-all-insights"
                                class="inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 hover:bg-accent hover:text-accent-foreground h-9 px-3"
                                title="Expand/Collapse All `E`"
                                aria-label="Expand or collapse all insights (E)">
                            <svg id="expand-all-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 20 5-5 5 5"/><path d="m7 4 5 5 5-5"/></svg>
                            <span class="hidden sm:inline">Expand All</span>
                            <kbd class="hidden sm:inline-flex h-5 select-none items-center rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground">E</kbd>
                        </button>
                    </div>
                    <div id="insights-list" class="space-y-4" role="list"></div>
                </div>
            </section>
        </div>

        </div>
    </main>

    
    <footer class="w-full border-t">
        <div class="w-full max-w-7xl mx-auto px-6 py-6">
            <div class="text-center">
                <p class="text-sm text-muted-foreground mb-1">Generated by Bundle Inspector</p>
                <p class="text-sm">
                    <a href="https://analyze.bitrise.io" target="_blank" rel="noopener noreferrer" class="font-semibold text-primary hover:underline transition-colors">Create your own report</a>
                </p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        const reportData = {"fileTree":{"fileType":"resource","name":"AndroidManifest.xml","path":"AndroidManifest.xml","value":192},"categories":[{"name":"Resources","value":192}],"extensions":[{"name":".xml","value":192}],"optimizations":[],"duplicates":[],"metadata":{"has_manifest":true}};

        
        
        
        const SafeHTML = {
            
            escapeText(str) {
                if (str == null) return '';
                const div = document.createElement('div');
                div.textContent = String(str);
                return div.innerHTML;
            },

            
            createElement(tag, attrs = {}, children = []) {
                const el = document.createElement(tag);

                for (const [key, value] of Object.entries(attrs)) {
                    if (key === 'className') {
                        el.className = value;
                    } else if (key === 'innerHTML') {
                        
                        console.warn('SafeHTML: Use children or textContent instead of innerHTML');
                    } else if (key === 'textContent') {
                        el.textContent = value;
                    } else if (key.startsWith('data-')) {
                        el.setAttribute(key, value);
                    } else if (key === 'style' && typeof value === 'object') {
                        Object.assign(el.style, value);
                    } else if (typeof value === 'boolean') {
                        if (value) el.setAttribute(key, '');
                    } else {
                        el.setAttribute(key, value);
                    }
                }

                for (const child of children) {
                    if (typeof child === 'string') {
                        el.appendChild(document.createTextNode(child));
                    } else if (child instanceof Node) {
                        el.appendChild(child);
                    }
                }

                return el;
            },

            
            text(str) {
                return document.createTextNode(str == null ? '' : String(str));
            }
        };

        
        function safeGetElement(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn('Element not found: ' + id);
            }
            return el;
        }

        
        const ALLOWED_URL_DOMAINS = [
            'devcenter.bitrise.io',
            'bitrise.io',
            'github.com',
            'developer.apple.com',
            'developer.android.com'
        ];

        function isValidLearnMoreURL(url) {
            if (!url || typeof url !== 'string') return false;
            try {
                const parsed = new URL(url);
                
                if (parsed.protocol !== 'https:') return false;
                
                return ALLOWED_URL_DOMAINS.some(domain =>
                    parsed.hostname === domain || parsed.hostname.endsWith('.' + domain)
                );
            } catch {
                return false;
            }
        }

        
        
        
        const AppState = {
            theme: 'light',
            charts: {
                treemap: null,
                category: null,
                extension: null
            },
            originalData: {
                fileTree: null,
                categories: null,
                extensions: null
            },
            duplicatePaths: new Set(reportData.duplicates || []),
            dataTableStates: {},
            searchCache: new Map(), 
            maxCacheSize: 20,

            isDark() {
                return this.theme === 'dark';
            },

            
            getCachedSearch(query) {
                return this.searchCache.get(query) || null;
            },

            
            setCachedSearch(query, result) {
                if (this.searchCache.size >= this.maxCacheSize) {
                    
                    const firstKey = this.searchCache.keys().next().value;
                    this.searchCache.delete(firstKey);
                }
                this.searchCache.set(query, result);
            },

            
            clearSearchCache() {
                this.searchCache.clear();
            },

            setTheme(theme) {
                this.theme = theme;
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            },

            init() {
                this.theme = localStorage.getItem('theme') || 'light';
                if (this.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                }
                
                if (reportData.fileTree) {
                    this.originalData.fileTree = JSON.parse(JSON.stringify(reportData.fileTree));
                }
                if (reportData.categories) {
                    this.originalData.categories = JSON.parse(JSON.stringify(reportData.categories));
                }
                if (reportData.extensions) {
                    this.originalData.extensions = JSON.parse(JSON.stringify(reportData.extensions));
                }
            }
        };

        
        let currentTheme = 'light';
        let treemapChart = null;
        let categoryChart = null;
        let extensionChart = null;
        let originalFileTree = null;
        let originalCategories = null;
        let originalExtensions = null;

        
        
        
        const TreeUtils = {
            
            deepCopy(node) {
                if (!node) return null;
                const copy = {
                    name: node.name,
                    value: node.value
                };
                if (node.path) copy.path = node.path;
                if (node.fileType) copy.fileType = node.fileType;
                if (node.itemStyle) copy.itemStyle = JSON.parse(JSON.stringify(node.itemStyle));
                if (node.isDuplicate) copy.isDuplicate = node.isDuplicate;
                if (node.children && node.children.length > 0) {
                    copy.children = node.children.map(child => TreeUtils.deepCopy(child));
                }
                return copy;
            },

            
            traverse(node, visitor, depth = 0) {
                if (!node) return;
                visitor(node, depth);
                if (node.children) {
                    node.children.forEach(child => TreeUtils.traverse(child, visitor, depth + 1));
                }
            },

            
            collect(node, predicate) {
                const results = [];
                TreeUtils.traverse(node, (n) => {
                    if (predicate(n)) results.push(n);
                });
                return results;
            },

            
            filter(node, predicate) {
                if (!node) return null;

                const matches = predicate(node);
                const isLeaf = !node.children || node.children.length === 0;

                if (isLeaf) {
                    return matches ? TreeUtils.deepCopy(node) : null;
                }

                const filteredChildren = node.children
                    .map(child => TreeUtils.filter(child, predicate))
                    .filter(child => child !== null);

                if (filteredChildren.length > 0 || matches) {
                    const copy = TreeUtils.deepCopy(node);
                    if (filteredChildren.length > 0) {
                        copy.children = filteredChildren;
                        copy.value = filteredChildren.reduce((sum, child) => sum + child.value, 0);
                    }
                    return copy;
                }

                return null;
            },

            
            findByName(node, targetName) {
                if (!node) return null;
                if (node.name.toLowerCase() === targetName.toLowerCase()) {
                    return TreeUtils.deepCopy(node);
                }
                if (node.children) {
                    for (const child of node.children) {
                        const found = TreeUtils.findByName(child, targetName);
                        if (found) return found;
                    }
                }
                return null;
            },

            
            aggregate(node, aggregator, initialValue = 0) {
                let result = initialValue;
                TreeUtils.traverse(node, (n) => {
                    result = aggregator(result, n);
                });
                return result;
            }
        };

        
        
        
        const ChartFactory = {
            instances: new Map(),
            resizeHandler: null,

            
            create(containerId, optionFn, data) {
                const container = safeGetElement(containerId);
                if (!container) return null;

                
                if (this.instances.has(containerId)) {
                    this.instances.get(containerId).dispose();
                }

                const chartOptions = containerId === 'treemap'
                    ? { renderer: 'canvas', useDirtyRect: true }
                    : {};

                const chart = echarts.init(container, null, chartOptions);
                const option = optionFn(data);
                chart.setOption(option);

                this.instances.set(containerId, chart);
                this.ensureResizeHandler();

                return chart;
            },

            
            update(containerId, optionFn, data) {
                const chart = this.instances.get(containerId);
                if (chart) {
                    const option = optionFn(data);
                    chart.setOption(option, true);
                }
            },

            
            resize(containerId) {
                const chart = this.instances.get(containerId);
                if (chart) {
                    chart.resize();
                }
            },

            
            resizeAll() {
                this.instances.forEach(chart => chart.resize());
            },

            
            ensureResizeHandler() {
                if (this.resizeHandler) return;

                let resizeTimeout;
                this.resizeHandler = () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.resizeAll(), 100);
                };
                window.addEventListener('resize', this.resizeHandler);
            },

            
            disposeAll() {
                this.instances.forEach(chart => chart.dispose());
                this.instances.clear();
                if (this.resizeHandler) {
                    window.removeEventListener('resize', this.resizeHandler);
                    this.resizeHandler = null;
                }
            }
        };

        
        
        
        function getBaseTooltipConfig() {
            const isDark = AppState.isDark();
            const themeColors = getThemeColors();
            return {
                backgroundColor: isDark ? '#2a2a2a' : '#fff',
                borderColor: isDark ? '#3a3a3a' : '#e5e5e7',
                textStyle: {
                    color: themeColors.textColor
                }
            };
        }

        
        function generateTreemapLevels(isDark) {
            const levels = [
                { itemStyle: { borderWidth: 0, gapWidth: 4 }, upperLabel: { show: false } }
            ];

            const levelConfigs = [
                { gapWidth: 2, borderWidth: 2, borderColor: isDark ? '#444' : '#ddd', height: 28, fontSize: 13, opacity: isDark ? 0.6 : 0.7 },
                { gapWidth: 2, borderWidth: 1, borderColor: isDark ? '#555' : '#eee', height: 24, fontSize: 12, opacity: isDark ? 0.5 : 0.6 },
                { gapWidth: 1, borderWidth: 1, borderColor: isDark ? '#555' : '#eee', height: 22, fontSize: 11, opacity: isDark ? 0.4 : 0.5 },
                { gapWidth: 1, borderWidth: 1, borderColor: undefined, height: 20, fontSize: 10, opacity: isDark ? 0.35 : 0.45 },
                { gapWidth: 1, borderWidth: 1, borderColor: undefined, height: 18, fontSize: 9, opacity: isDark ? 0.3 : 0.4 }
            ];

            levelConfigs.forEach(cfg => {
                const level = {
                    itemStyle: {
                        gapWidth: cfg.gapWidth,
                        borderWidth: cfg.borderWidth
                    },
                    upperLabel: {
                        show: true,
                        height: cfg.height,
                        formatter: function(params) {
                            return '{bg|' + params.name + '}';
                        },
                        rich: {
                            bg: {
                                backgroundColor: 'rgba(0,0,0,' + cfg.opacity + ')',
                                color: '#fff',
                                fontWeight: cfg.fontSize >= 12 ? 'bold' : 'normal',
                                fontSize: cfg.fontSize,
                                padding: cfg.fontSize >= 12 ? [4, 8] : (cfg.fontSize >= 10 ? [2, 5] : [1, 3]),
                                borderRadius: cfg.fontSize >= 11 ? 3 : 2
                            }
                        }
                    }
                };
                if (cfg.borderColor) {
                    level.itemStyle.borderColor = cfg.borderColor;
                }
                levels.push(level);
            });

            return levels;
        }

        
        function switchTab(tabName) {
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.classList.remove('active');
                button.classList.remove('bg-background', 'text-foreground', 'shadow-sm');
            });
            tabPanels.forEach(panel => panel.classList.remove('active'));

            
            const selectedButton = event.target;
            selectedButton.classList.add('active', 'bg-background', 'text-foreground', 'shadow-sm');

            const selectedPanel = safeGetElement(tabName + '-panel');
            if (selectedPanel) selectedPanel.classList.add('active');

            
            if (tabName === 'category') {
                setTimeout(() => {
                    ChartFactory.resize('category-chart');
                    ChartFactory.resize('extension-chart');
                }, 100);
            } else if (tabName === 'app-analyzer') {
                setTimeout(() => {
                    ChartFactory.resize('treemap');
                }, 100);
            }
        }

        
        function initTheme() {
            
        }

        
        function toggleTheme() {
            const newTheme = AppState.theme === 'light' ? 'dark' : 'light';
            AppState.setTheme(newTheme);
            currentTheme = newTheme; 
            updateThemeButton();
            updateChartsTheme();
        }

        
        function updateThemeButton() {
            const buttons = document.querySelectorAll('[data-action="toggle-theme"]');
            buttons.forEach(button => {
                const svg = button.querySelector('svg');
                if (svg) {
                    if (AppState.isDark()) {
                        svg.style.transform = 'rotate(180deg)';
                        button.setAttribute('aria-label', 'Toggle Mode (D)');
                        button.setAttribute('title', 'Toggle Mode `D`');
                    } else {
                        svg.style.transform = 'rotate(0deg)';
                        button.setAttribute('aria-label', 'Toggle Mode (D)');
                        button.setAttribute('title', 'Toggle Mode `D`');
                    }
                }
            });
        }

        
        function updateChartsTheme() {
            ChartFactory.update('treemap', getTreemapOption, reportData.fileTree);
            ChartFactory.update('category-chart', getCategoryChartOption, reportData.categories);
            ChartFactory.update('extension-chart', getExtensionChartOption, reportData.extensions);
        }

        
        function getThemeColors() {
            const isDark = AppState.isDark();
            return {
                textColor: isDark ? '#f5f5f7' : '#1d1d1f',
                backgroundColor: isDark ? 'transparent' : 'transparent',
                axisLineColor: isDark ? '#3a3a3a' : '#e5e5e7',
                splitLineColor: isDark ? '#3a3a3a' : '#e5e5e7',
            };
        }

        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }

        
        function truncatePath(path, maxLen) {
            maxLen = maxLen || 80;
            if (path.length <= maxLen) {
                return path;
            }

            
            const lastSep = path.lastIndexOf('/');
            if (lastSep === -1) {
                
                if (maxLen > 3) {
                    return '...' + path.slice(-(maxLen - 3));
                }
                return path.slice(0, maxLen);
            }

            const filename = path.slice(lastSep + 1);
            const dirPath = path.slice(0, lastSep);

            
            if (filename.length >= maxLen - 4) { 
                return '.../' + filename.slice(0, maxLen - 4);
            }

            
            const ellipsis = '/.../';
            const availableForDir = maxLen - filename.length - ellipsis.length;

            if (availableForDir <= 0) {
                
                return '.../' + filename;
            }

            
            if (availableForDir >= dirPath.length) {
                return path; 
            }

            return dirPath.slice(0, availableForDir) + ellipsis + filename;
        }

        
        function getCSSVariable(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        
        function getFileTypeColors() {
            return {
                'framework': getCSSVariable('--color-framework'),
                'library': getCSSVariable('--color-library'),
                'native': getCSSVariable('--color-native'),
                'image': getCSSVariable('--color-image'),
                'asset_catalog': getCSSVariable('--color-asset-catalog'),
                'resource': getCSSVariable('--color-resource'),
                'ui': getCSSVariable('--color-ui'),
                'dex': getCSSVariable('--color-dex'),
                'font': getCSSVariable('--color-font'),
                'video': getCSSVariable('--color-video'),
                'audio': getCSSVariable('--color-audio'),
                'mlmodel': getCSSVariable('--color-mlmodel'),
                'localization': getCSSVariable('--color-localization'),
                'other': getCSSVariable('--color-other'),
                'duplicate': getCSSVariable('--color-duplicate')
            };
        }

        
        function getColorForFileType(fileType) {
            const colors = getFileTypeColors();
            return colors[fileType] || colors['other'];
        }

        
        function darkenColor(hex, factor) {
            
            hex = hex.replace(/^#/, '');

            
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);

            
            r = Math.round(r * (1 - factor));
            g = Math.round(g * (1 - factor));
            b = Math.round(b * (1 - factor));

            
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        
        
        function getColorBrightness(hex) {
            
            hex = hex.replace(/^#/, '');

            
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);

            
            
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        
        function getTextColorForBackground(bgColor) {
            const brightness = getColorBrightness(bgColor);
            
            return brightness > 128 ? '#000' : '#fff';
        }

        
        function getDominantFileType(node) {
            if (node.fileType) {
                return node.fileType;
            }
            if (!node.children || node.children.length === 0) {
                return 'other';
            }

            
            const typeSizes = {};
            function countTypes(n) {
                if (n.fileType && n.value) {
                    typeSizes[n.fileType] = (typeSizes[n.fileType] || 0) + n.value;
                }
                if (n.children) {
                    n.children.forEach(countTypes);
                }
            }
            countTypes(node);

            
            let dominantType = 'other';
            let maxSize = 0;
            for (const type in typeSizes) {
                if (typeSizes[type] > maxSize) {
                    maxSize = typeSizes[type];
                    dominantType = type;
                }
            }
            return dominantType;
        }

        
        function applyColorsToTree(node, depth) {
            depth = depth || 0;
            const isParent = node.children && node.children.length > 0;

            
            const isDexNode = node.path === 'Dex' || (node.path && node.path.startsWith('Dex/'));

            
            let nodeColor;

            if (isDexNode) {
                
                nodeColor = getCSSVariable('--color-dex');
            } else if (isParent) {
                
                const headerLevel = Math.min(depth, 4);
                nodeColor = getCSSVariable('--color-header-' + headerLevel);
            } else {
                
                const colors = getFileTypeColors();
                if (node.path && AppState.duplicatePaths.has(node.path)) {
                    nodeColor = colors['duplicate'];
                    node.isDuplicate = true;
                } else {
                    const fileType = node.fileType || getDominantFileType(node);
                    nodeColor = getColorForFileType(fileType);
                }
            }

            
            node.itemStyle = node.itemStyle || {};
            node.itemStyle.color = nodeColor;

            
            const textColor = getTextColorForBackground(nodeColor);
            node.label = node.label || {};
            node.label.color = textColor;

            
            if (isParent) {
                node.itemStyle.borderColor = darkenColor(nodeColor, 0.2);
            }

            if (node.children) {
                node.children.forEach(child => applyColorsToTree(child, depth + 1));
            }
        }

        
        function getTreemapOption(data) {
            
            applyColorsToTree(data);

            const isDark = AppState.isDark();
            const tooltipConfig = getBaseTooltipConfig();
            const borderColor = isDark ? '#666' : '#fff';
            const emphasisBorder = isDark ? '#fff' : '#333';

            return {
                tooltip: {
                    ...tooltipConfig,
                    formatter: function(info) {
                        const value = info.value;
                        const name = SafeHTML.escapeText(info.name);
                        const path = SafeHTML.escapeText(info.data.path || info.name);
                        const isDuplicate = info.data.isDuplicate || false;
                        const metadata = info.data.metadata || {};
                        const treePathInfo = info.treePathInfo || [];
                        let percentage = '0.0';

                        if (treePathInfo.length > 0) {
                            const rootValue = treePathInfo[0].value;
                            if (rootValue > 0) {
                                percentage = ((value / rootValue) * 100).toFixed(2);
                            }
                        }

                        let result = '<strong>' + name + '</strong><br/>' +
                               'Path: ' + path + '<br/>' +
                               'Size: ' + formatBytes(value) + '<br/>' +
                               percentage + '%% of total';

                        
                        if (metadata.class_type === 'dex_class') {
                            result += '<br/><br/><em>DEX Class</em><br/>';
                            result += 'Methods: ' + (metadata.method_count || 0) + '<br/>';
                            result += 'Fields: ' + (metadata.field_count || 0) + '<br/>';
                            if (metadata.source_dex) {
                                result += 'Source: ' + SafeHTML.escapeText(metadata.source_dex) + '<br/>';
                            }
                            result += '<br/><small style="color: var(--color-muted);">Private size only</small>';
                        }

                        
                        if (metadata.class_type === 'unmapped_dex') {
                            result += '<br/><br/><em>Shared Data</em><br/>';
                            if (metadata.description) {
                                result += SafeHTML.escapeText(metadata.description) + '<br/>';
                            }
                            result += '<br/><small style="color: var(--color-muted);">Cannot be attributed to specific classes</small>';
                        }

                        if (isDuplicate) {
                            result += '<br/><span style="color: var(--color-duplicate); font-weight: bold;"> Duplicate file</span>';
                        }

                        return result;
                    }
                },
                series: [{
                    type: 'treemap',
                    width: '100%%',
                    height: '100%%',
                    roam: true,
                    nodeClick: 'zoomToNode',
                    leafDepth: 5,
                    zoomToNodeRatio: 0.32 * 0.32,
                    scaleLimit: { min: 0.5, max: 20 },
                    drillDownIcon: '',
                    colorMappingBy: 'value',
                    breadcrumb: {
                        show: true,
                        top: 5,
                        left: 5,
                        height: 28,
                        emptyItemWidth: 25,
                        itemStyle: {
                            color: isDark ? 'rgba(60,60,60,0.95)' : 'rgba(80,80,80,0.9)',
                            borderColor: isDark ? 'rgba(80,80,80,0.9)' : 'rgba(60,60,60,0.8)',
                            borderWidth: 1,
                            borderRadius: 4,
                            textStyle: { color: '#fff', fontSize: 12 }
                        },
                        emphasis: {
                            itemStyle: {
                                color: isDark ? 'rgba(80,80,80,1)' : 'rgba(60,60,60,1)',
                                textStyle: { color: '#fff' }
                            }
                        }
                    },
                    label: {
                        show: true,
                        formatter: '{b}',
                        fontSize: 11,
                        overflow: 'truncate'
                        
                    },
                    itemStyle: {
                        borderColor: borderColor,
                        borderWidth: 2,
                        gapWidth: 2
                    },
                    emphasis: {
                        label: { show: true, fontSize: 12, fontWeight: 'bold' },
                        itemStyle: { borderColor: emphasisBorder, borderWidth: 3 }
                    },
                    visibleMin: 200,
                    childrenVisibleMin: 100,
                    levels: generateTreemapLevels(isDark),
                    data: [data]
                }]
            };
        }

        
        function createTreemap(data) {
            const chart = ChartFactory.create('treemap', getTreemapOption, data);
            
            treemapChart = chart;
            AppState.charts.treemap = chart;
            return chart;
        }

        
        function getCategoryChartOption(categories) {
            const isDark = AppState.isDark();
            const tooltipConfig = getBaseTooltipConfig();
            const themeColors = getThemeColors();

            return {
                tooltip: {
                    ...tooltipConfig,
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%%', '70%%'],
                    avoidLabelOverlap: true,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: isDark ? '#2a2a2a' : '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: function(params) {
                            return SafeHTML.escapeText(params.name) + '\n' + formatBytes(params.value);
                        },
                        fontSize: 11,
                        color: themeColors.textColor
                    },
                    emphasis: {
                        label: { show: true, fontSize: 13, fontWeight: 'bold' }
                    },
                    data: categories.map(cat => ({
                        name: cat.name,
                        value: cat.value
                    }))
                }]
            };
        }

        
        function createCategoryChart(categories) {
            const chart = ChartFactory.create('category-chart', getCategoryChartOption, categories);
            
            categoryChart = chart;
            AppState.charts.category = chart;
            return chart;
        }

        
        function getExtensionChartOption(extensions) {
            const isDark = AppState.isDark();
            const tooltipConfig = getBaseTooltipConfig();
            const themeColors = getThemeColors();

            return {
                tooltip: {
                    ...tooltipConfig,
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const data = params[0];
                        return SafeHTML.escapeText(data.name) + ': ' + formatBytes(data.value);
                    }
                },
                grid: {
                    left: '5%%',
                    right: '5%%',
                    bottom: '3%%',
                    top: '3%%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: (value) => formatBytes(value),
                        fontSize: 10,
                        color: themeColors.textColor
                    },
                    axisLine: {
                        lineStyle: {
                            color: themeColors.axisLineColor
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: themeColors.splitLineColor
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: extensions.map(e => e.name),
                    axisLabel: {
                        fontSize: 10,
                        color: themeColors.textColor
                    },
                    axisLine: {
                        lineStyle: {
                            color: themeColors.axisLineColor
                        }
                    }
                },
                series: [{
                    type: 'bar',
                    data: extensions.map(e => e.value),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: getCSSVariable('--color-framework') || '#9247C2' },
                            { offset: 1, color: getCSSVariable('--color-library') || '#0dd3c5' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: (params) => formatBytes(params.value),
                        fontSize: 10,
                        color: themeColors.textColor
                    }
                }]
            };
        }

        
        function createExtensionChart(extensions) {
            const chart = ChartFactory.create('extension-chart', getExtensionChartOption, extensions);
            
            extensionChart = chart;
            AppState.charts.extension = chart;
            return chart;
        }

        
        const icons = {
            lightbulb: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.3A7 7 0 0 0 12 2z"/></svg>',
            wrench: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
            package: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4l-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
            copy: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
            image: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
            camera: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
            file: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            checkCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        };

        
        const categoryMetadata = {
            'strip-symbols': {
                icon: icons.wrench,
                title: 'Strip Binary Symbols',
                description: 'Remove debug symbols from binaries to reduce file size without affecting app functionality.',
                learnMore: 'https://devcenter.bitrise.io/en/deploying/ios-deployment/strip-debug-symbols.html'
            },
            'frameworks': {
                icon: icons.package,
                title: 'Unused Frameworks',
                description: 'Frameworks included in your bundle but not referenced or used by your application.',
                learnMore: 'https://devcenter.bitrise.io/en/builds/build-cache.html'
            },
            'duplicates': {
                icon: icons.copy,
                title: 'Duplicate Files',
                description: 'Identical files appearing multiple times in your bundle, wasting storage space.',
                learnMore: 'https://devcenter.bitrise.io/en/builds/build-cache.html'
            },
            'image-optimization': {
                icon: icons.image,
                title: 'Image Optimization',
                description: 'Images that can be compressed or converted to more efficient formats to reduce size.',
                learnMore: 'https://devcenter.bitrise.io/en/deploying/ios-deployment/optimizing-app-size.html'
            },
            'loose-images': {
                icon: icons.camera,
                title: 'Loose Images',
                description: 'Images stored as individual files instead of being compiled into asset catalogs.',
                learnMore: 'https://devcenter.bitrise.io/en/deploying/ios-deployment/optimizing-app-size.html'
            },
            'unnecessary-files': {
                icon: icons.trash,
                title: 'Unnecessary Files',
                description: 'Files that are not needed in production builds and can be safely removed.',
                learnMore: 'https://devcenter.bitrise.io/en/deploying/ios-deployment/optimizing-app-size.html'
            },
            'small-files': {
                icon: icons.file,
                title: 'Small Files',
                description: 'Files smaller than 4KB waste disk space due to iOS filesystem block size allocation. Each file takes up at least 4KB regardless of actual content.',
                learnMore: 'https://docs.emergetools.com/docs/avoid-many-files#small-files'
            }
        };

        
        function groupByCategory(optimizations) {
            const groups = {};

            optimizations.forEach(opt => {
                if (!groups[opt.category]) {
                    groups[opt.category] = {
                        items: [],
                        totalSavings: 0,
                        totalFiles: 0,
                        description: ''
                    };
                }

                groups[opt.category].items.push(opt);
                groups[opt.category].totalSavings += opt.impact;
                groups[opt.category].totalFiles += (opt.files ? opt.files.length : 0);

                
                if (!groups[opt.category].description && opt.description) {
                    groups[opt.category].description = opt.description;
                }
            });

            return groups;
        }

        
        function renderEmptyInsights(container) {
            container.textContent = '';

            const wrapper = SafeHTML.createElement('div', {
                className: 'flex flex-col items-center justify-center py-10 gap-3'
            });

            
            const iconSpan = SafeHTML.createElement('span', {
                className: 'text-success w-12 h-12'
            });
            iconSpan.innerHTML = icons.checkCircle.replace('width="24" height="24"', 'width="48" height="48"');
            wrapper.appendChild(iconSpan);

            
            wrapper.appendChild(SafeHTML.createElement('span', {
                className: 'text-lg font-semibold text-success',
                textContent: 'No optimization opportunities found!'
            }));

            
            wrapper.appendChild(SafeHTML.createElement('span', {
                className: 'text-sm text-muted-foreground',
                textContent: 'Your bundle is well optimized.'
            }));

            container.appendChild(wrapper);
        }

        
        function createInsightCard(category, group, metadata, index, totalSize) {
            const savingsPercentage = totalSize > 0
                ? ((group.totalSavings / totalSize) * 100).toFixed(2)
                : '0.00';

            const card = SafeHTML.createElement('div', {
                className: 'insight-card rounded-lg border bg-card overflow-hidden transition-all duration-200 hover:shadow-md',
                id: 'insight-' + index
            });

            
            const header = SafeHTML.createElement('div', {
                className: 'flex items-start gap-3 p-4 cursor-pointer select-none',
                'data-action': 'toggle-insight',
                'data-index': String(index)
            });

            
            const iconDiv = SafeHTML.createElement('div', {
                className: 'flex-shrink-0 w-6 h-6 text-primary'
            });
            iconDiv.innerHTML = metadata.icon; 
            header.appendChild(iconDiv);

            
            const content = SafeHTML.createElement('div', { className: 'flex-1 min-w-0' });

            
            const titleRow = SafeHTML.createElement('div', {
                className: 'flex items-center justify-between gap-2 mb-1.5'
            });
            titleRow.appendChild(SafeHTML.createElement('h3', {
                className: 'text-sm font-semibold leading-none tracking-tight',
                textContent: metadata.title
            }));

            
            const expandSvg = SafeHTML.createElement('svg', {
                className: 'expand-indicator w-4 h-4 text-muted-foreground flex-shrink-0 transition-transform duration-200',
                fill: 'none',
                stroke: 'currentColor',
                viewBox: '0 0 24 24'
            });
            expandSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
            titleRow.appendChild(expandSvg);
            content.appendChild(titleRow);

            
            content.appendChild(SafeHTML.createElement('p', {
                className: 'text-sm text-muted-foreground leading-normal mb-2.5',
                textContent: metadata.description || group.description
            }));

            
            const statsRow = SafeHTML.createElement('div', {
                className: 'flex items-center gap-2 flex-wrap text-xs'
            });

            
            const savingsBadge = SafeHTML.createElement('span', {
                className: 'inline-flex items-center gap-1.5 font-semibold bg-success/10 text-success px-2 py-1 rounded-md'
            });
            savingsBadge.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>';
            savingsBadge.appendChild(SafeHTML.text(' ' + formatBytes(group.totalSavings) + ' (' + savingsPercentage + '%)'));
            statsRow.appendChild(savingsBadge);

            
            const filesBadge = SafeHTML.createElement('span', {
                className: 'inline-flex items-center gap-1 text-muted-foreground px-2 py-1 bg-muted/50 rounded-md font-medium'
            });
            filesBadge.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>';
            filesBadge.appendChild(SafeHTML.text(' ' + group.totalFiles + ' files'));
            statsRow.appendChild(filesBadge);

            
            if (isValidLearnMoreURL(metadata.learnMore)) {
                const learnMoreLink = SafeHTML.createElement('a', {
                    href: metadata.learnMore,
                    className: 'inline-flex items-center gap-0.5 text-primary hover:underline font-medium transition-colors',
                    target: '_blank',
                    rel: 'noopener noreferrer'
                });
                learnMoreLink.appendChild(SafeHTML.text('Learn more'));
                const arrowSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                arrowSvg.setAttribute('class', 'w-3 h-3');
                arrowSvg.setAttribute('fill', 'none');
                arrowSvg.setAttribute('stroke', 'currentColor');
                arrowSvg.setAttribute('viewBox', '0 0 24 24');
                arrowSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
                learnMoreLink.appendChild(arrowSvg);
                statsRow.appendChild(learnMoreLink);
            }

            content.appendChild(statsRow);
            header.appendChild(content);
            card.appendChild(header);

            
            const filesSection = SafeHTML.createElement('div', {
                className: 'insight-files border-t border-border'
            });
            const filesContent = SafeHTML.createElement('div', {
                className: 'insight-files-content p-4 bg-muted/30'
            });

            
            const tableId = 'table-' + category + '-' + index;
            if (category === 'duplicates') {
                filesContent.innerHTML = renderDuplicateGroups(group.items, tableId);
            } else {
                filesContent.innerHTML = renderFilesTable(group.items, tableId);
            }

            filesSection.appendChild(filesContent);
            card.appendChild(filesSection);

            return card;
        }

        
        function renderInsights(optimizations) {
            const container = safeGetElement('insights-list');
            if (!container) return;

            if (!optimizations || optimizations.length === 0) {
                renderEmptyInsights(container);
                return;
            }

            
            container.textContent = '';

            const groups = groupByCategory(optimizations);
            const totalSize = reportData.fileTree ? reportData.fileTree.value : 0;

            
            const sortedCategories = Object.keys(groups)
                .map(category => ({
                    category: category,
                    group: groups[category]
                }))
                .sort((a, b) => b.group.totalSavings - a.group.totalSavings);

            
            sortedCategories.forEach((item, index) => {
                const { category, group } = item;
                const metadata = categoryMetadata[category] || {
                    icon: icons.lightbulb,
                    title: category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    description: 'Optimization opportunities to reduce your bundle size.',
                    learnMore: 'https://devcenter.bitrise.io'
                };

                const card = createInsightCard(category, group, metadata, index, totalSize);
                container.appendChild(card);
            });

            
            const badge = document.getElementById('insights-badge');
            if (badge && optimizations.length > 0) {
                badge.textContent = optimizations.length;
                badge.classList.remove('hidden');
            }
        }

        
        function toggleInsight(index) {
            const card = safeGetElement('insight-' + index);
            if (!card) return;
            const filesContainer = card.querySelector('.insight-files');
            const content = filesContainer.querySelector('.insight-files-content');

            if (card.classList.contains('expanded')) {
                
                filesContainer.style.maxHeight = '0';
                card.classList.remove('expanded');
            } else {
                
                const height = content.scrollHeight;
                filesContainer.style.maxHeight = height + 'px';
                card.classList.add('expanded');
            }
        }

        
        let allInsightsExpanded = false;

        
        function toggleAllInsights() {
            const cards = document.querySelectorAll('.insight-card');
            if (cards.length === 0) return;

            allInsightsExpanded = !allInsightsExpanded;

            cards.forEach(card => {
                const filesContainer = card.querySelector('.insight-files');
                const content = filesContainer.querySelector('.insight-files-content');

                if (allInsightsExpanded) {
                    
                    const height = content.scrollHeight;
                    filesContainer.style.maxHeight = height + 'px';
                    card.classList.add('expanded');
                } else {
                    
                    filesContainer.style.maxHeight = '0';
                    card.classList.remove('expanded');
                }
            });

            
            updateExpandAllButton();
        }

        
        function updateExpandAllButton() {
            const button = document.querySelector('[data-action="toggle-all-insights"]');
            if (!button) return;

            const textSpan = button.querySelector('span');
            if (textSpan) {
                textSpan.textContent = allInsightsExpanded ? 'Collapse All' : 'Expand All';
            }

            const icon = button.querySelector('svg');
            if (icon) {
                
                icon.style.transform = allInsightsExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                icon.style.transition = 'transform 0.2s ease';
            }
        }

        
        function switchToTab(tabName) {
            const tabButton = document.querySelector('[data-action="switch-tab"][data-tab="' + tabName + '"]');
            if (!tabButton) return;

            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active', 'bg-background', 'text-foreground', 'shadow-sm');
            });
            tabButton.classList.add('active', 'bg-background', 'text-foreground', 'shadow-sm');

            
            const tabPanels = document.querySelectorAll('.tab-panel');
            tabPanels.forEach(panel => panel.classList.remove('active'));
            const selectedPanel = safeGetElement(tabName + '-panel');
            if (selectedPanel) selectedPanel.classList.add('active');

            
            if (tabName === 'category') {
                setTimeout(() => {
                    ChartFactory.resize('category-chart');
                    ChartFactory.resize('extension-chart');
                }, 100);
            } else if (tabName === 'app-analyzer') {
                setTimeout(() => {
                    ChartFactory.resize('treemap');
                }, 100);
            }
        }

        
        function createDataTable(tableId, data, columns, options = {}) {
            const pageSize = options.pageSize || 10;
            const state = {
                data: data,
                columns: columns,
                sortColumn: options.defaultSort || null,
                sortDirection: options.defaultSortDir || 'desc',
                currentPage: 0,
                pageSize: pageSize
            };
            AppState.dataTableStates[tableId] = state;

            
            if (state.sortColumn) {
                sortDataTable(tableId, state.sortColumn, false);
            }

            return renderDataTable(tableId);
        }

        
        function sortDataTable(tableId, column, toggle = true) {
            const state = AppState.dataTableStates[tableId];
            if (!state) return;

            if (toggle && state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else if (toggle) {
                state.sortColumn = column;
                state.sortDirection = 'desc';
            }

            state.data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return state.sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return state.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            state.currentPage = 0;
        }

        
        function changeDataTablePage(tableId, page) {
            const state = AppState.dataTableStates[tableId];
            if (!state) return;

            const maxPage = Math.ceil(state.data.length / state.pageSize) - 1;
            state.currentPage = Math.max(0, Math.min(page, maxPage));

            
            const container = safeGetElement(tableId);
            if (container) {
                container.outerHTML = renderDataTable(tableId);
            }
        }

        
        function handleDataTableSort(tableId, column) {
            sortDataTable(tableId, column, true);
            const container = safeGetElement(tableId);
            if (container) {
                container.outerHTML = renderDataTable(tableId);
            }
        }

        
        function renderDataTable(tableId) {
            const state = AppState.dataTableStates[tableId];
            if (!state) return '';

            const { data, columns, sortColumn, sortDirection, currentPage, pageSize } = state;
            const totalPages = Math.ceil(data.length / pageSize);
            const startIdx = currentPage * pageSize;
            const endIdx = Math.min(startIdx + pageSize, data.length);
            const pageData = data.slice(startIdx, endIdx);

            let html = '<div id="' + tableId + '" class="space-y-3">';

            
            html += '<div class="rounded-md border overflow-hidden">';
            html += '<table class="w-full text-sm">';

            
            html += '<thead class="bg-muted/50">';
            html += '<tr class="border-b border-border">';
            columns.forEach(col => {
                const isSorted = sortColumn === col.key;
                const sortIcon = isSorted
                    ? (sortDirection === 'asc'
                        ? '<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>'
                        : '<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>')
                    : '<svg class="w-4 h-4 ml-1 opacity-0 group-hover:opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>';

                const alignClass = col.align === 'right' ? 'text-right justify-end' : 'text-left';
                const widthClass = col.width ? ' ' + col.width : '';

                if (col.sortable !== false) {
                    html += '<th class="h-10 px-4 align-middle font-medium text-muted-foreground' + widthClass + '">';
                    html += '<button onclick="handleDataTableSort(\'' + tableId + '\', \'' + col.key + '\')" class="group inline-flex items-center gap-1 hover:text-foreground transition-colors ' + alignClass + ' w-full">';
                    html += col.label + sortIcon;
                    html += '</button>';
                    html += '</th>';
                } else {
                    html += '<th class="h-10 px-4 align-middle font-medium text-muted-foreground ' + alignClass + widthClass + '">' + col.label + '</th>';
                }
            });
            html += '</tr>';
            html += '</thead>';

            
            html += '<tbody class="divide-y divide-border">';
            pageData.forEach((row, idx) => {
                const rowClass = idx % 2 === 0 ? 'bg-background' : 'bg-muted/20';
                html += '<tr class="' + rowClass + ' hover:bg-muted/50 transition-colors">';
                columns.forEach(col => {
                    const alignClass = col.align === 'right' ? 'text-right' : 'text-left';
                    html += '<td class="p-4 align-top ' + alignClass + '">';
                    const cellValue = col.render ? col.render(row) : (row[col.key] || '');
                    html += cellValue;
                    html += '</td>';
                });
                html += '</tr>';
            });
            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            
            html += '<div class="flex items-center justify-between px-2">';
            html += '<div class="text-sm text-muted-foreground">';
            html += 'Showing ' + (startIdx + 1) + '-' + endIdx + ' of ' + data.length + ' files';
            html += '</div>';

            if (totalPages > 1) {
                html += '<div class="flex items-center gap-1">';

                
                const prevDisabled = currentPage === 0;
                html += '<button onclick="changeDataTablePage(\'' + tableId + '\', ' + (currentPage - 1) + ')" ' + (prevDisabled ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md text-sm font-medium h-8 w-8 border border-input bg-background hover:bg-accent hover:text-accent-foreground disabled:pointer-events-none disabled:opacity-50">';
                html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>';
                html += '</button>';

                
                const maxVisiblePages = 5;
                let startPage = Math.max(0, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages);
                if (endPage - startPage < maxVisiblePages) {
                    startPage = Math.max(0, endPage - maxVisiblePages);
                }

                for (let i = startPage; i < endPage; i++) {
                    const isCurrentPage = i === currentPage;
                    const pageClass = isCurrentPage
                        ? 'bg-primary text-primary-foreground'
                        : 'border border-input bg-background hover:bg-accent hover:text-accent-foreground';
                    html += '<button onclick="changeDataTablePage(\'' + tableId + '\', ' + i + ')" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-8 w-8 ' + pageClass + '">';
                    html += (i + 1);
                    html += '</button>';
                }

                
                const nextDisabled = currentPage >= totalPages - 1;
                html += '<button onclick="changeDataTablePage(\'' + tableId + '\', ' + (currentPage + 1) + ')" ' + (nextDisabled ? 'disabled' : '') + ' class="inline-flex items-center justify-center rounded-md text-sm font-medium h-8 w-8 border border-input bg-background hover:bg-accent hover:text-accent-foreground disabled:pointer-events-none disabled:opacity-50">';
                html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
                html += '</button>';

                html += '</div>';
            }

            html += '</div>';
            html += '</div>';

            return html;
        }

        
        function renderFilesTable(items, tableId) {
            
            const fileMap = new Map();
            items.forEach(item => {
                if (item.files && item.files.length > 0) {
                    item.files.forEach(file => {
                        
                        
                        if (file.includes('|')) {
                            const parts = file.split('|');
                            const filePath = parts[0];
                            const fileSavings = parseInt(parts[1], 10);
                            const existing = fileMap.get(filePath) || 0;
                            fileMap.set(filePath, existing + fileSavings);
                        } else {
                            
                            const perFileSavings = Math.floor(item.impact / item.files.length);
                            const existing = fileMap.get(file) || 0;
                            fileMap.set(file, existing + perFileSavings);
                        }
                    });
                }
            });

            
            const files = Array.from(fileMap.entries())
                .map(([path, savings]) => ({
                    path,
                    savings,
                    filename: path.split('/').pop()
                }));

            if (files.length === 0) {
                return '<p class="text-sm text-muted-foreground">No files to display.</p>';
            }

            const columns = [
                {
                    key: 'filename',
                    label: 'File',
                    sortable: true,
                    width: 'w-1/4',
                    render: (row) => {
                        const filename = row.filename || 'Unknown';
                        return '<span class="text-sm font-medium truncate block" title="' + filename + '">' + filename + '</span>';
                    }
                },
                {
                    key: 'path',
                    label: 'Path',
                    sortable: false,
                    render: (row) => {
                        const path = row.path || '';
                        return '<div class="max-w-2xl"><div class="text-xs font-mono text-muted-foreground py-0.5 break-all">' + path + '</div></div>';
                    }
                },
                {
                    key: 'savings',
                    label: 'Savings',
                    align: 'right',
                    width: 'w-32',
                    sortable: true,
                    render: (row) => {
                        const savings = row.savings || 0;
                        return '<span class="text-sm font-semibold text-success bg-success/10 px-2 py-1 rounded-md inline-block">' + formatBytes(savings) + '</span>';
                    }
                }
            ];

            return createDataTable(tableId, files, columns, {
                defaultSort: 'savings',
                defaultSortDir: 'desc',
                pageSize: 10
            });
        }

        
        function renderDuplicateGroups(items, baseTableId) {
            
            const sortedItems = [...items].sort((a, b) => b.impact - a.impact);

            
            const tableData = sortedItems.map(item => {
                if (!item.files || item.files.length === 0) return null;

                const firstFile = item.files[0];
                const filename = firstFile.split('/').pop();

                return {
                    file: filename,
                    locations: item.files.join(', '),
                    locationsArray: item.files, 
                    count: item.files.length,
                    savings: item.impact,
                    savingsFormatted: formatBytes(item.impact)
                };
            }).filter(item => item !== null);

            const columns = [
                {
                    key: 'file',
                    label: 'File',
                    sortable: true,
                    width: 'w-1/4',
                    render: (row) => {
                        const file = row.file || 'Unknown';
                        const count = row.count || 0;
                        return '<div class="flex items-center gap-2">' +
                            '<span class="text-sm font-medium truncate" title="' + file + '">' + file + '</span>' +
                            '<span class="text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded flex-shrink-0">' + count + 'x</span>' +
                            '</div>';
                    }
                },
                {
                    key: 'locations',
                    label: 'Locations',
                    sortable: false,
                    render: (row) => {
                        const locations = row.locationsArray || [];
                        const locationsList = locations.map(loc =>
                            '<div class="text-xs font-mono text-muted-foreground py-0.5 break-all">' + (loc || '') + '</div>'
                        ).join('');
                        return '<div class="space-y-0.5 py-1 max-w-2xl">' + locationsList + '</div>';
                    }
                },
                {
                    key: 'savings',
                    label: 'Savings',
                    align: 'right',
                    width: 'w-32',
                    sortable: true,
                    render: (row) => {
                        const savings = row.savingsFormatted || formatBytes(0);
                        return '<span class="text-sm font-semibold text-success bg-success/10 px-2 py-1 rounded-md inline-block">' + savings + '</span>';
                    }
                }
            ];

            return createDataTable(baseTableId, tableData, columns, {
                pageSize: 10,
                defaultSort: 'savings',
                defaultSortDir: 'desc'
            });
        }

        
        function extractAllFiles(node, parentPath = '', isRoot = false) {
            const files = [];

            if (!node) return files;

            
            let currentPath;
            if (isRoot || (parentPath === '' && node.name === 'root')) {
                currentPath = './';
            } else if (parentPath === './') {
                currentPath = './' + node.name;
            } else if (parentPath) {
                currentPath = parentPath + '/' + node.name;
            } else {
                currentPath = node.name;
            }

            
            if (!node.children || node.children.length === 0) {
                files.push({
                    path: currentPath,
                    filename: node.name,
                    type: node.fileType || 'other',
                    size: node.value || 0
                });
            }

            
            if (node.children) {
                node.children.forEach(child => {
                    const childFiles = extractAllFiles(child, currentPath, false);
                    files.push(...childFiles);
                });
            }

            return files;
        }

        
        function getAllFiles() {
            if (!reportData.fileTree) return [];

            let allFiles = [];

            
            if (Array.isArray(reportData.fileTree)) {
                reportData.fileTree.forEach(rootNode => {
                    allFiles.push(...extractAllFiles(rootNode, '', true));
                });
            } else {
                allFiles = extractAllFiles(reportData.fileTree, '', true);
            }

            
            allFiles.sort((a, b) => b.size - a.size);

            return allFiles;
        }

        
        let allFilesData = [];
        let filteredFilesData = [];

        
        function renderFilesTabTable() {
            const container = document.getElementById('files-table-container');
            if (!container) return;

            const files = filteredFilesData.length > 0 ? filteredFilesData : allFilesData;

            if (files.length === 0) {
                container.innerHTML = '<p class="text-sm text-muted-foreground text-center py-8">No files found</p>';
                return;
            }

            const columns = [
                {
                    key: 'path',
                    label: 'Path',
                    sortable: true,
                    render: (row) => {
                        return '<div class="max-w-2xl"><div class="text-sm font-mono text-foreground py-0.5 break-all">' + row.path + '</div></div>';
                    }
                },
                {
                    key: 'type',
                    label: 'Type',
                    width: 'w-32',
                    sortable: true,
                    render: (row) => {
                        const typeLabels = {
                            'framework': 'Framework',
                            'library': 'Library',
                            'native': 'Native',
                            'image': 'Image',
                            'asset_catalog': 'Asset Catalog',
                            'resource': 'Resource',
                            'ui': 'UI',
                            'dex': 'DEX',
                            'font': 'Font',
                            'video': 'Video',
                            'audio': 'Audio',
                            'mlmodel': 'ML Model',
                            'localization': 'Localization',
                            'duplicate': 'Duplicate',
                            'other': 'Other'
                        };
                        const label = typeLabels[row.type] || 'Other';
                        return '<span class="text-xs font-medium text-muted-foreground bg-muted px-2 py-1 rounded">' + label + '</span>';
                    }
                },
                {
                    key: 'size',
                    label: 'Size',
                    align: 'right',
                    width: 'w-32',
                    sortable: true,
                    render: (row) => {
                        return '<span class="text-sm font-semibold">' + formatBytes(row.size) + '</span>';
                    }
                }
            ];

            container.innerHTML = createDataTable('files-table', files, columns, {
                pageSize: 25,
                defaultSort: 'size',
                defaultSortDir: 'desc'
            });
        }

        
        function filterFiles(query) {
            if (!query || query.trim() === '') {
                filteredFilesData = [];
                renderFilesTabTable();
                return;
            }

            const lowerQuery = query.toLowerCase();
            filteredFilesData = allFilesData.filter(file => {
                return file.path.toLowerCase().includes(lowerQuery) ||
                       file.filename.toLowerCase().includes(lowerQuery) ||
                       file.type.toLowerCase().includes(lowerQuery);
            });

            renderFilesTabTable();
        }

        
        function initFilesTable() {
            allFilesData = getAllFiles();
            renderFilesTabTable();
        }

        
        const LEGEND_ITEMS = [
            { color: '--color-duplicate', label: 'Duplicates' },
            { color: '--color-framework', label: 'Frameworks' },
            { color: '--color-library', label: 'Libraries' },
            { color: '--color-native', label: 'Native Libs' },
            { color: '--color-image', label: 'Images' },
            { color: '--color-video', label: 'Videos' },
            { color: '--color-audio', label: 'Audio' },
            { color: '--color-mlmodel', label: 'ML Models' },
            { color: '--color-dex', label: 'DEX' },
            { color: '--color-asset-catalog', label: 'Asset Catalogs' },
            { color: '--color-font', label: 'Fonts' },
            { color: '--color-localization', label: 'Localization' },
            { color: '--color-resource', label: 'Resources' },
            { color: '--color-ui', label: 'UI' },
            { color: '--color-other', label: 'Other' }
        ];

        
        function renderLegend() {
            const container = safeGetElement('legend-container');
            if (!container) return;

            container.textContent = '';

            LEGEND_ITEMS.forEach(item => {
                const legendItem = SafeHTML.createElement('div', {
                    className: 'legend-item',
                    role: 'listitem'
                });

                const colorBox = SafeHTML.createElement('div', {
                    className: 'legend-color',
                    style: { background: 'var(' + item.color + ')' },
                    'aria-hidden': 'true'
                });

                const label = SafeHTML.createElement('span', {
                    className: 'text-xs text-muted-foreground',
                    textContent: item.label
                });

                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                container.appendChild(legendItem);
            });
        }

        
        document.addEventListener('DOMContentLoaded', function() {
            
            AppState.init();
            currentTheme = AppState.theme; 
            updateThemeButton();

            
            originalFileTree = AppState.originalData.fileTree;
            originalCategories = AppState.originalData.categories;
            originalExtensions = AppState.originalData.extensions;

            
            renderLegend();

            
            if (reportData.fileTree) {
                createTreemap(reportData.fileTree);
            }
            if (reportData.categories && reportData.categories.length > 0) {
                createCategoryChart(reportData.categories);
            }
            if (reportData.extensions && reportData.extensions.length > 0) {
                createExtensionChart(reportData.extensions);
            }
            if (reportData.optimizations) {
                renderInsights(reportData.optimizations);
            }

            
            initFilesTable();

            
            setupEventDelegation();

            
            const filesSearchInput = document.getElementById('files-search-input');
            if (filesSearchInput) {
                let debounceTimer;
                filesSearchInput.addEventListener('input', function(e) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        filterFiles(e.target.value);
                    }, 300);
                });
            }
        });

        
        function setupEventDelegation() {
            document.body.addEventListener('click', function(event) {
                const target = event.target.closest('[data-action]');
                if (!target) return;

                const action = target.getAttribute('data-action');

                switch (action) {
                    case 'toggle-theme':
                        toggleTheme();
                        break;

                    case 'switch-tab':
                        const tabName = target.getAttribute('data-tab');
                        if (tabName) {
                            
                            const tabButtons = document.querySelectorAll('.tab-button');
                            tabButtons.forEach(button => {
                                button.classList.remove('active', 'bg-background', 'text-foreground', 'shadow-sm');
                            });
                            target.classList.add('active', 'bg-background', 'text-foreground', 'shadow-sm');

                            
                            const tabPanels = document.querySelectorAll('.tab-panel');
                            tabPanels.forEach(panel => panel.classList.remove('active'));
                            const selectedPanel = safeGetElement(tabName + '-panel');
                            if (selectedPanel) selectedPanel.classList.add('active');

                            
                            if (tabName === 'category') {
                                setTimeout(() => {
                                    ChartFactory.resize('category-chart');
                                    ChartFactory.resize('extension-chart');
                                }, 100);
                            } else if (tabName === 'app-analyzer') {
                                setTimeout(() => {
                                    ChartFactory.resize('treemap');
                                }, 100);
                            }
                        }
                        break;

                    case 'toggle-insight':
                        
                        if (event.target.tagName === 'A' || event.target.closest('a')) {
                            break;
                        }
                        const index = target.getAttribute('data-index');
                        if (index !== null) {
                            toggleInsight(parseInt(index, 10));
                        }
                        break;

                    case 'toggle-all-insights':
                        toggleAllInsights();
                        break;
                }
            });
        }

        
        document.addEventListener('keydown', function(event) {
            
            if (['INPUT', 'TEXTAREA'].includes(event.target.tagName)) {
                return;
            }

            
            
            if (event.metaKey || event.ctrlKey || event.altKey || event.shiftKey) {
                return;
            }

            const key = event.key.toLowerCase();

            switch (key) {
                case 'd':
                    event.preventDefault();
                    toggleTheme();
                    break;

                case 'a':
                    event.preventDefault();
                    switchToTab('app-analyzer');
                    break;

                case 'c':
                    event.preventDefault();
                    switchToTab('category');
                    break;

                case 'f':
                    event.preventDefault();
                    switchToTab('files');
                    break;

                case 'i':
                    event.preventDefault();
                    switchToTab('insights');
                    break;

                case 'e':
                    event.preventDefault();
                    toggleAllInsights();
                    break;
            }
        });

        
        function parseSearchQuery(query) {
            if (!query) {
                return { mode: 'empty', query: '' };
            }

            
            const backtickMatch = query.match(/`([^`]+)`/);
            if (backtickMatch) {
                return { mode: 'backtick', query: backtickMatch[1].toLowerCase() };
            }

            
            if (query.includes('/')) {
                return { mode: 'path', query: query.toLowerCase() };
            }

            
            return { mode: 'basic', query: query.toLowerCase() };
        }

        
        const deepCopyNode = TreeUtils.deepCopy;

        
        function filterTreeByQuery(tree, searchMode, query) {
            if (!tree || searchMode === 'empty') {
                return tree;
            }

            
            if (searchMode === 'backtick') {
                const foundNode = TreeUtils.findByName(tree, query);
                if (foundNode) {
                    
                    return {
                        name: tree.name,
                        value: foundNode.value,
                        children: [foundNode]
                    };
                }
                return null;
            }

            
            if (searchMode === 'path') {
                return TreeUtils.filter(tree, node => {
                    const nodePath = (node.path || '').toLowerCase();
                    const nodeName = node.name.toLowerCase();
                    return nodePath.includes(query) || nodeName.includes(query);
                });
            }

            
            if (searchMode === 'basic') {
                return TreeUtils.filter(tree, node => {
                    const nodeName = node.name.toLowerCase();
                    const nodePath = (node.path || '').toLowerCase();
                    const nodeType = (node.fileType || '').toLowerCase();
                    return nodeName.includes(query) || nodePath.includes(query) || nodeType.includes(query);
                });
            }

            return tree;
        }

        
        function calculateStatsFromTree(tree) {
            const categoryMap = {};
            const extensionMap = {};

            TreeUtils.traverse(tree, node => {
                
                if (node.fileType && node.value) {
                    categoryMap[node.fileType] = (categoryMap[node.fileType] || 0) + node.value;
                }

                
                const isLeaf = !node.children || node.children.length === 0;
                if (isLeaf && node.name && node.value) {
                    const lastDot = node.name.lastIndexOf('.');
                    if (lastDot > 0) {
                        const ext = node.name.substring(lastDot);
                        extensionMap[ext] = (extensionMap[ext] || 0) + node.value;
                    } else {
                        extensionMap['(no ext)'] = (extensionMap['(no ext)'] || 0) + node.value;
                    }
                }
            });

            
            const categories = Object.entries(categoryMap)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);

            const extensions = Object.entries(extensionMap)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 10); 

            return { categories, extensions };
        }

        
        function updateChartsWithFilteredData(filteredTree, categories, extensions) {
            if (filteredTree) {
                ChartFactory.update('treemap', getTreemapOption, filteredTree);
            }
            if (categories && categories.length > 0) {
                ChartFactory.update('category-chart', getCategoryChartOption, categories);
            }
            if (extensions && extensions.length > 0) {
                ChartFactory.update('extension-chart', getExtensionChartOption, extensions);
            }
        }

        
        let searchTimeout = null;
        const searchInput = safeGetElement('search-input');
        if (searchInput) searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();

            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            
            searchTimeout = setTimeout(function() {
                const parsed = parseSearchQuery(query);

                
                if (parsed.mode === 'empty') {
                    if (AppState.originalData.fileTree) {
                        updateChartsWithFilteredData(
                            TreeUtils.deepCopy(AppState.originalData.fileTree),
                            AppState.originalData.categories.slice(),
                            AppState.originalData.extensions.slice()
                        );
                    }
                    return;
                }

                
                const cacheKey = parsed.mode + ':' + parsed.query;

                
                let cached = AppState.getCachedSearch(cacheKey);
                if (cached) {
                    updateChartsWithFilteredData(
                        TreeUtils.deepCopy(cached.tree),
                        cached.categories,
                        cached.extensions
                    );
                    return;
                }

                
                const filteredTree = filterTreeByQuery(
                    TreeUtils.deepCopy(AppState.originalData.fileTree),
                    parsed.mode,
                    parsed.query
                );

                
                if (!filteredTree || (filteredTree.children && filteredTree.children.length === 0)) {
                    const emptyResult = {
                        tree: { name: 'No results', value: 0, children: [] },
                        categories: [],
                        extensions: []
                    };
                    AppState.setCachedSearch(cacheKey, emptyResult);
                    updateChartsWithFilteredData(emptyResult.tree, [], []);
                    return;
                }

                
                const stats = calculateStatsFromTree(filteredTree);

                
                AppState.setCachedSearch(cacheKey, {
                    tree: filteredTree,
                    categories: stats.categories,
                    extensions: stats.extensions
                });

                
                updateChartsWithFilteredData(filteredTree, stats.categories, stats.extensions);
            }, 300);
        });
    </script>
</body>
</html>
